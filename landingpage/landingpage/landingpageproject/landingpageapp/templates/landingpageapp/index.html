{% load static %}
<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
        href="{% static 'landingpageapp/css/styling.css'%}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <title>Programming Journey</title>
</head>

<body>
    <div id="app">
        <ul class="nav justify-content-end sticky-top mt-1">
            <li class="nav-item" v-for="category in categories">
                <a class="nav-link active" v-on:click="postIndex"  aria-current="page" v-bind:value="category.id" href="#">[[category.name]]</a>
            </li>
            <li>
                <button type="button" class="btn btn-primary"  data-bs-toggle="modal" data-bs-target="#exampleModal">
                    New Post
                </button>
            </li>
        </ul>
        <div id="main_image">
            
        </div>
        <div class="container">

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">New Post</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control" placeholder="title" v-model="title"  id="FormControlTextarea1" rows="1"></textarea>
                        <textarea class="form-control" placeholder="body" v-model="text" id="FormControlTextarea1" rows="3"></textarea>
                        <input class="form-control form-control-sm" id="post_image" type="file" accept="image/*" />
                        <select class="form-select form-select-sm" v-model="category_id" aria-label=".form-select-sm ">
                            <option value="" disabled selected>category</option>
                            <option v-for="category in categories" v-bind:value="category.id" >[[category.name]]</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" v-on:click="newPost" class="btn btn-primary">post</button>
                    </div>
                </div>
            </div>
        </div>

        
            <div class="card mt-1" v-for="post in posts">
                <div class="card-body">
                    <h5 class="card-title">[[post.title]]</h5>
                    <p><strong>[[post.category]]</strong></p>
                    <p class="card-text">[[post.text]]</p>

                    <p class="card-text"><small class="text-muted">[[post.created_date]]</small></p>
                </div>
                <img v-bind:src="post.post_image" class="card-img-bottom" alt="...">
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    <script>
        let app = new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data: {
                posts: [],
                text: '',
                title: '',
                category:'',
                created_date: '',
                post_image: '',
                category_id: '',
                categories: '',
                category_sort: '',
            },
            methods: {
                postIndex: function () {
                    axios({
                        url: "{% url 'landingpageapp:load_posts' %}",
                        method: 'get',
                        params: {
                            sort: this.category_sort
                        }
                    }).then(response => {
                        if (this.category_sort){
                            this.postIndex = response.data.filter(post => this.category_sort === post.category_id)
                        }
                        else {
                        this.posts = response.data.posts
                        }
                    })
                },
                newPost: function (){
                    console.log(this.category_id, 'cat_id')
                    console.log(this.text, 'text')
                    console.log(this.title, 'title')
                    let form_data = new FormData()
                    let post_image = document.querySelector('#post_image')
                    form_data.append('post_image', post_image.files[0])
                    form_data.append('text', this.text )
                    form_data.append('title', this.title)
                    form_data.append('created_date', this.created_date)
                    form_data.append('category_id', this.category_id )
                    axios({
                        url: "{% url 'landingpageapp:new_post' %}",
                        method: "post",
                        data: form_data,
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}" 
                        }
                    }).then(response => {
                        this.text = ''
                        this.title = ''
                        post_image.value = ''
                        this.category_id = ''
                        this.postIndex()
                    })

                },
                loadCategories: function (){
                    axios({
                        url: "{% url 'landingpageapp:get_categories' %}",
                        method: 'get'
                    }).then(response => {
                        this.categories = response.data.categories
                    })
                }
            },
            created: function () {
                this.postIndex()
                this.loadCategories()
            }
        })
    </script>
</body>

</html>